!function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";function s(e,t="Failed assert"){if(!e)throw new Error(t)}n.r(t);const i=["","M=","D=","MD=","A=","AM=","AD=","AMD="],o=["",";JGT",";JEQ",";JGE",";JLT",";JNE",";JLE",";JMP"],r=Symbol(),a=["D&A","!(D&A)","D+A",r,"D&!A","!(D&!A)",r,"A-D",r,r,r,r,"D","!D","D-1","-D","!D&A","D|!A",r,"D-A","!D&!A","D|A",r,r,r,r,r,r,r,r,r,"D+1",r,r,r,r,r,r,r,r,r,r,"0",r,r,r,r,r,"A","!A","A-1","-A",r,r,r,"A+1",r,r,"-1",r,r,r,r,"1","D&M","!(D&M)","D+M",r,"D&!M","!D|M",r,"M-D",r,r,r,r,r,r,r,r,"!D&M","D|!M",r,"D-M","!D&!M","D|M",r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,"M","!M","M-1","-M",r,r,r,"M+1",r,r,r,r,r,r,r,r].map((e,t)=>e===r?"X"+t.toString(16).toUpperCase():e);function c(e){if(s(/^[01]{16}$/.test(e),`Instruction '${e}' does not match format.`),"0"===e[0])return t=parseInt(e,2),{type:"a",eval:e=>{e.a=t,e.pc++},emit:()=>"@"+t};var t;return function(e,t,n){return{type:"c",eval:s=>{let i=s.d,o=64&e?s.m:s.a;32&e&&(i=0),16&e&&(i=65535&~i),8&e&&(o=0),4&e&&(o=65535&~o);let r=2&e?i+o&65535:i&o;1&e&&(r=65535&~r),1&t&&(s.m=r),2&t&&(s.d=r),4&t&&(s.a=r);const a=32768&r,c=0===r;n&((a?4:0)|(c?2:0)|(a||c?0:1))?s.pc=s.a:s.pc++},emit:()=>`${i[t]}${a[e]}${o[n]}`}}(parseInt(e.substr(3,7),2),parseInt(e.substr(10,3),2),parseInt(e.substr(13,3),2))}class l{constructor(){this._pc=0,this.a=0,this.d=0,this.ram=Array.from({length:32768}).fill(0)}get m(){return s(this.a<=32767,"Accessed memory OOB, a="+this.a),this.ram[this.a]}set m(e){s(this.a<=32767,"Accessed memory OOB, a="+this.a),this.ram[this.a]=e}get pc(){return this._pc}set pc(e){s(e<=32767,"PC out of bounds, tried to set "+e),this._pc=e}}class p{constructor(e){this._ticks=0,this.cpu=new l,this.histogram=Array.from({length:32768}).fill(0);const t=e.slice();for(;t.length<32768;)t.push(c("0000000000000000"));this.rom=t}get ram(){return this.cpu.ram}get ticks(){return this._ticks}step(){this._ticks++,this.histogram[this.cpu.pc]++,this.rom[this.cpu.pc].eval(this.cpu)}toString(){return`Machine { a = ${this.cpu.a}, d = ${this.cpu.d}, m = ${this.cpu.m}, pc = ${this.cpu.pc}}`}}function u(e,t){Number.isNaN(t)||t<0||t>e.scrollHeight+e.clientHeight||(e.scrollTop+e.clientHeight<t?e.scrollTop=t-Math.floor(2*e.clientHeight/3):t<e.scrollTop&&(e.scrollTop=t-Math.floor(1*e.clientHeight/3)))}console.log("Inspect the window.machine global after loading a hack file.");const d=e=>document.querySelector(e);function m(e){let t="";return 32768&e&&(e=1+(32767&~e),t="-"),t+e.toString()}const f=d("#load-hack"),h=d("#load-ram"),v=d("#action-step"),w=d("#action-step-x"),b=d("#input-step-x"),M=d("#d-value"),g=d("#a-value"),D=d("#m-value"),y=d("#pc-value"),A=d("#input-step-rate"),T=d("#playing-label");T.textContent="▶";const $=d("canvas"),E=$.getContext("2d"),x=new Set;let k;function S(){clearTimeout(k),k=void 0,A.disabled=v.disabled=w.disabled=b.disabled=!1,T.textContent="▶"}d("#action-reset").addEventListener("click",()=>{S(),O(window.fileText)},{passive:!0}),d("#action-step-rate").addEventListener("click",()=>{k?S():function(){A.disabled=v.disabled=w.disabled=b.disabled=!0,T.textContent="❙❙";const e=+A.value/1e3;k=setTimeout((function t(){H(1),k=setTimeout(t,e)}),e)}()},{passive:!0}),v.addEventListener("click",()=>H(1),{passive:!0}),Mousetrap.bind("s",e=>{e.preventDefault(),k||H(1)}),w.addEventListener("click",()=>H(+b.value),{passive:!0}),Mousetrap.bind("x",e=>{e.preventDefault(),k||H(+b.value)}),Mousetrap.bind("shift+x",e=>{if(e.preventDefault(),!k&&window.machine){const e=+(prompt("How many steps?",b.value)||"");!Number.isNaN(e)&&e>0&&H(e)}});const L=new Clusterize({rows:[],scrollElem:d("#rom .clusterize-scroll"),contentElem:d("#rom .clusterize-content")});Mousetrap.bind("mod+g",e=>{e.preventDefault();const t=+(prompt("Which ROM address?")||"");u(L.scroll_elem,24*t)}),L.content_elem.addEventListener("input",e=>{const t=e.target,n=t.parentElement;if(!n)return;const s=n.dataset.pc;s&&(t.checked?(x.add(+s),n.classList.add("bp")):(x.delete(+s),n.classList.remove("bp")))}),Mousetrap.bind("mod+b",e=>{if(e.preventDefault(),window.machine){x.add(window.machine.cpu.pc);const e=L.content_elem.querySelector(`[data-pc="${window.machine.cpu.pc}"]`);e instanceof HTMLElement&&(e.classList.add("bp"),e.querySelector("input").checked=!0)}}),Mousetrap.bind("mod+shift+b",e=>{if(e.preventDefault(),window.machine){const e=+(prompt("Where in ROM should be breakpoint be set?",window.machine.cpu.pc.toString())||"");if(!Number.isNaN(e)){x.add(e);const t=L.content_elem.querySelector(`[data-pc="${e}"]`);t instanceof HTMLElement&&(t.classList.add("bp"),t.querySelector("input").checked=!0)}}});const _=new Clusterize({rows:[],scrollElem:d("#ram .clusterize-scroll"),contentElem:d("#ram .clusterize-content")});Mousetrap.bind("mod+h",e=>{e.preventDefault();const t=+(prompt("Which RAM address?")||"");u(_.scroll_elem,24*t)});const C=new Clusterize({rows:[],scrollElem:d("#stack .clusterize-scroll"),contentElem:d("#stack .clusterize-content")});function O(e){var t;try{!function(e){S(),window.machine=new p(e),H(0),E&&(E.fillStyle="white",E.fillRect(0,0,$.width,$.height))}(null!==(t=null==e?void 0:e.split("\n").map(e=>e.trim()).filter(Boolean).map(c))&&void 0!==t?t:[])}catch(e){alert(e.message)}}function R(e){!function(){const e=window.machine;if(!e)return;M.textContent=m(e.cpu.d),g.textContent=m(e.cpu.a),D.textContent=e.cpu.a<32768?m(e.cpu.m):"Out of bounds",y.textContent=m(e.cpu.pc)}(),L.update(e.rom.map((t,n)=>{let s=`<div data-pc="${n}" class="row`;return n===e.cpu.pc&&(s+=" hl"),x.has(n)&&(s+=" bp"),s+='"><input type="checkbox"',x.has(n)&&(s+=" checked"),`${s}><strong>${n}</strong><span>${t.emit()}</span></div>`})),u(L.scroll_elem,24*e.cpu.pc);const t={0:"SP",1:"LCL",2:"ARG",3:"THIS",4:"THAT",5:"Temp 0",6:"Temp 1",7:"Temp 2",8:"Temp 3",9:"Temp 4",10:"Temp 5",11:"Temp 6",12:"Temp 7",13:"R13",14:"R14",15:"R15",16384:"SCREEN",24576:"KBD"},n=e=>t[e]?`${e} | ${t[e]}`:""+e;_.update(e.ram.map((t,s)=>s===e.cpu.a?`<div class="row hl"><strong>${n(s)}</strong><span>${m(t)}</span></div>`:`<div class="row"><strong>${n(s)}</strong><span>${m(t)}</span></div>`)),u(_.scroll_elem,24*e.cpu.a),C.update(e.ram.slice(256,e.ram[0]+5).map((t,n)=>n+256===e.ram[0]?`<div class="row hl"><strong>${n+256}</strong><span>${m(t)}</span></div>`:`<div class="row"><strong>${n+256}</strong><span>${m(t)}</span></div>`)),u(C.scroll_elem,24*(e.ram[0]-256))}function N(e=window.machine){if(E&&e)for(let t=16384;t<32767;t++){const n=Math.floor((t-16384)/32),s=16*(t-16384-32*n),i=e.ram[t];for(let e=0;e<16;e++)E.fillStyle=i&1<<e?"black":"white",E.fillRect(s+e,n,1,1)}}function H(e){const t=window.machine;if(t)try{for(let n=0;n<e&&(t.step(),!x.has(t.cpu.pc));n++);}catch(e){alert(e.message)}finally{R(t),N(t)}}f.addEventListener("input",()=>{f.files&&f.files[0]&&function(e){const t=new FileReader;t.addEventListener("load",()=>{window.fileText=t.result,O(window.fileText)},{passive:!0}),t.readAsText(e)}(f.files[0])},{passive:!0}),Mousetrap.bind("mod+o",e=>{e.preventDefault(),f.click()}),h.addEventListener("input",()=>{h.files&&h.files[0]&&function(e){const t=new FileReader;t.addEventListener("load",()=>{if(!window.machine)return void alert("Can't load RAM without a machine. Load hack file first.");const e=t.result;for(const t of e.split(/\r?\n/)){const e=t.match(/^RAM\[(\d{1,5})\]: (\d+)$/);if(e){const t=parseInt(e[1],10);let n=parseInt(e[2],10);n<0&&(n=65535&-n,n|=32768),window.machine.ram[t]=65535&n}}R(window.machine),N()},{passive:!0}),t.readAsText(e)}(h.files[0])},{passive:!0}),Mousetrap.bind("mod+shift+o",e=>{e.preventDefault(),h.click()})}]);